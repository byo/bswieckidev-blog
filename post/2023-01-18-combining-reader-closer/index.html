<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Quick way to combine io.Reader and io.Closer | Just a dev blog</title><meta name=keywords content="go,til,code"><meta name=description content="There are many interesting tools in Golang&rsquo;s standard library to wrap io.Reader instance such as io.LimitedReader or cipher.StreamReader. But when wrapping a io.ReadCloser instance, the Close method is hidden.
Here&rsquo;s a quick code snippet to combine wrapped io.Reader and the original io.Closer through an inline struct to rebuild the io.Closer interface.
Code var rc io.ReadCloser = struct { io.Reader io.Closer }{ Reader: r, Closer: c, } What it is about? The io."><meta name=author content><link rel=canonical href=https://blog.bswiecki.dev/post/2023-01-18-combining-reader-closer/><link crossorigin=anonymous href=https://blog.bswiecki.dev/assets/css/stylesheet.bccfefac377bc340f06c260aed1bddf49a4354816d7c570d6aac75a997986c95.css integrity="sha256-vM/vrDd7w0DwbCYK7Rvd9JpDVIFtfFcNaqx1qZeYbJU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=https://blog.bswiecki.dev/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.bswiecki.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.bswiecki.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://blog.bswiecki.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://blog.bswiecki.dev/apple-touch-icon.png><link rel=mask-icon href=https://blog.bswiecki.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Quick way to combine io.Reader and io.Closer"><meta property="og:description" content="There are many interesting tools in Golang&rsquo;s standard library to wrap io.Reader instance such as io.LimitedReader or cipher.StreamReader. But when wrapping a io.ReadCloser instance, the Close method is hidden.
Here&rsquo;s a quick code snippet to combine wrapped io.Reader and the original io.Closer through an inline struct to rebuild the io.Closer interface.
Code var rc io.ReadCloser = struct { io.Reader io.Closer }{ Reader: r, Closer: c, } What it is about? The io."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.bswiecki.dev/post/2023-01-18-combining-reader-closer/"><meta property="article:section" content="post"><meta property="article:published_time" content="2023-01-18T00:00:00+00:00"><meta property="article:modified_time" content="2023-01-18T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Quick way to combine io.Reader and io.Closer"><meta name=twitter:description content="There are many interesting tools in Golang&rsquo;s standard library to wrap io.Reader instance such as io.LimitedReader or cipher.StreamReader. But when wrapping a io.ReadCloser instance, the Close method is hidden.
Here&rsquo;s a quick code snippet to combine wrapped io.Reader and the original io.Closer through an inline struct to rebuild the io.Closer interface.
Code var rc io.ReadCloser = struct { io.Reader io.Closer }{ Reader: r, Closer: c, } What it is about? The io."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.bswiecki.dev/post/"},{"@type":"ListItem","position":2,"name":"Quick way to combine io.Reader and io.Closer","item":"https://blog.bswiecki.dev/post/2023-01-18-combining-reader-closer/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Quick way to combine io.Reader and io.Closer","name":"Quick way to combine io.Reader and io.Closer","description":"There are many interesting tools in Golang\u0026rsquo;s standard library to wrap io.Reader instance such as io.LimitedReader or cipher.StreamReader. But when wrapping a io.ReadCloser instance, the Close method is hidden.\nHere\u0026rsquo;s a quick code snippet to combine wrapped io.Reader and the original io.Closer through an inline struct to rebuild the io.Closer interface.\nCode var rc io.ReadCloser = struct { io.Reader io.Closer }{ Reader: r, Closer: c, } What it is about? The io.","keywords":["go","til","code"],"articleBody":"There are many interesting tools in Golang’s standard library to wrap io.Reader instance such as io.LimitedReader or cipher.StreamReader. But when wrapping a io.ReadCloser instance, the Close method is hidden.\nHere’s a quick code snippet to combine wrapped io.Reader and the original io.Closer through an inline struct to rebuild the io.Closer interface.\nCode var rc io.ReadCloser = struct { io.Reader io.Closer }{ Reader: r, Closer: c, } What it is about? The io.Reader interface in Golang is a very powerful abstraction when streaming data. It can be used to read files, http responses, even raw byte arrays using a generic code:\nfunc sumAllBytes(r io.Reader) (uint64, error) { var buff [512]byte var sum uint64 for { n, err := r.Read(buff[:]) for i := 0; i \u003c n; i++ { sum += uint64(buff[i]) } if errors.Is(err, io.EOF) { return sum, nil } if err != nil { return sum, err } } } That method can be used to process files, http responses, even memory buffers:\nfunc main() { // Process a buffer buff := bytes.NewReader([]byte{0x01, 0x02, 0x03, 0x04}) sum, err := sumAllBytes(buff) if err != nil { log.Fatal(err) } log.Println(\"Sum from buffer:\", sum) // Process a http response resp, err := http.Get(\"https://www.google.com\") if err != nil { log.Fatal(err) } defer resp.Body.Close() sum, err = sumAllBytes(resp.Body) if err != nil { log.Fatal(err) } log.Println(\"Sum from http:\", sum) // Process a file fl, err := os.Open(\"/some/file/path\") if err != nil { log.Fatal(err) } defer fl.Close() sum, err = sumAllBytes(fl) if err != nil { log.Fatal(err) } log.Println(\"Sum from file:\", sum) } Cleaning up In many cases (like the http and file instances above), the reader has to be explicitly closed to avoid resource leaks. For that reason, many resources are using the io.ReadCloser interface and cleaning up can easily be achieved with a defer rc.Close() statement. But there are some cases where the close method is not called at the same function but somewhere at the caller site. At that construct, the caller is responsible for cleanup:\nfunc getDataStream(name string) (io.ReadCloser, error) { switch name { case \"file\": return os.Open(\"/some/file\") case \"http\": resp, err := http.Get(\"https://www.google.com/\") if err != nil { return nil, err } return resp.Body, nil case \"buffer\": return io.NopCloser( bytes.NewReader([]byte{0x01, 0x02, 0x03, 0x04}), ), nil default: return nil, errors.New(\"Invalid data stream name\") } } func printSum(streamName string) { stream, err := getDataStream(streamName) if err != nil { log.Fatal(err) } defer stream.Close() sum, err := sumAllBytes(stream) if err != nil { log.Fatal(err) } log.Printf(\"Sum of bytes in stream '%s' is '%d\\n\", streamName, sum) } So far so good, nothing to worry about. But let’s extend this example with some stream wrapping:\nfunc getDataStream(name string) (io.ReadCloser, error) { switch name { case name == \"file\": return os.Open(\"/some/file\") case name == \"http\": resp, err := http.Get(\"https://www.google.com/\") if err != nil { return nil, err } return resp.Body, nil case name == \"buffer\": return io.NopCloser( bytes.NewReader([]byte{0x01, 0x02, 0x03, 0x04}), ), nil // v--- Create a truncated stream by applying limit over the base one ---v case strings.HasPrefix(name, \"limit:\"): r, err := getDataStream(name[6:]) if err != nil { return nil, err } return io.LimitReader(r, 3) default: return nil, errors.New(\"Invalid data stream name\") } } Unfortunately this code does not compile and ends up with this error:\ncannot use io.LimitReader(r, 100) (value of type io.Reader) as type io.ReadCloser in return statement: io.Reader does not implement io.ReadCloser (missing Close method) Wrapping the io.ReadCloser with io.LimitedReader does hide the io.Closer functionality of the original instance. And it turns out that there are many places in golang standard lib where such wrapping takes place.\nInline struct to the rescue There’s an easy trick to bring back the Close method from the original reader back to the wrapped one:\nfunc getDataStream(name string) (io.ReadCloser, error) { switch name { case name == \"file\": return os.Open(\"/some/file\") case name == \"http\": resp, err := http.Get(\"https://www.google.com/\") if err != nil { return nil, err } return resp.Body, nil case name == \"buffer\": return io.NopCloser( bytes.NewReader([]byte{0x01, 0x02, 0x03, 0x04}), ), nil // v--- Create a truncated stream by applying limit over the base one ---v case strings.HasPrefix(name, \"limit:\"): r, err := getDataStream(name[6:]) if err != nil { return nil, err } limitReader := io.LimitReader(r, 3) return struct { io.Reader io.Closer }{ Reader: limitReader, // Read method will come from the wrapped reader Closer: r, // Close method will come from the original reader }, nil default: return nil, errors.New(\"Invalid data stream name\") } } How does it work? The inline struct contains two embedded fields, one for the reader and the other for the closer.\nSince those fields are anonymous, the struct itself inherits methods from those fields as if those were declared on the struct. By doing so, whenever the compiler tries to cast the struct to some interface, it can promote those methods to fulfil the requirements of the interface.\nIn the code above we return an instance of io.ReadCloser interface that requires both Read and Close methods - and those are borrowed from embedded fields respectively.\nInterestingly, if we would use whole io.ReadCloser as the second embedded field instead of io.Reader, the compiler (go 1.19 as of writing) throws an error which is caused by ambiguity between promoted field members (the Read method is not promoted due to ambiguity):\ncannot use struct{io.Reader; io.ReadCloser}{…} (value of type struct{io.Reader; io.ReadCloser}) as type io.ReadCloser in return statement: struct{io.Reader; io.ReadCloser} does not implement io.ReadCloser (missing Read method) ","wordCount":"900","inLanguage":"en","datePublished":"2023-01-18T00:00:00Z","dateModified":"2023-01-18T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.bswiecki.dev/post/2023-01-18-combining-reader-closer/"},"publisher":{"@type":"Organization","name":"Just a dev blog","logo":{"@type":"ImageObject","url":"https://blog.bswiecki.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.bswiecki.dev/ accesskey=h title="Just a dev blog (Alt + H)">Just a dev blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://blog.bswiecki.dev/ title=Blog><span>Blog</span></a></li><li><a href=https://blog.bswiecki.dev/page/about/ title=About><span>About</span></a></li><li><a href=https://blog.bswiecki.dev/tags title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Quick way to combine io.Reader and io.Closer</h1><div class=post-meta><span title='2023-01-18 00:00:00 +0000 UTC'>January 18, 2023</span></div></header><div class=post-content><p>There are many interesting tools in Golang&rsquo;s standard library to wrap <a href=https://pkg.go.dev/io#Reader><code>io.Reader</code></a> instance such as <a href=https://pkg.go.dev/io#LimitedReader><code>io.LimitedReader</code></a> or <a href=https://pkg.go.dev/crypto/cipher#StreamReader><code>cipher.StreamReader</code></a>. But when wrapping a <a href=https://pkg.go.dev/io#ReadCloser><code>io.ReadCloser</code></a> instance, the <code>Close</code> method is hidden.</p><p>Here&rsquo;s a quick code snippet to combine wrapped <a href=https://pkg.go.dev/io#Reader><code>io.Reader</code></a> and the original <a href=https://pkg.go.dev/io#Closer><code>io.Closer</code></a> through an inline <code>struct</code> to rebuild the <a href=https://pkg.go.dev/io#Closer><code>io.Closer</code></a> interface.</p><h2 id=code>Code<a hidden class=anchor aria-hidden=true href=#code>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>rc</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadCloser</span> = <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Reader</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Closer</span>
</span></span><span style=display:flex><span>}{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Reader</span>: <span style=color:#a6e22e>r</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Closer</span>: <span style=color:#a6e22e>c</span>,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=what-it-is-about>What it is about?<a hidden class=anchor aria-hidden=true href=#what-it-is-about>#</a></h2><p>The <a href=https://pkg.go.dev/io#Reader><code>io.Reader</code></a> interface in Golang is a very powerful abstraction when streaming data. It can be used to read files, http responses, even raw byte arrays using a generic code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>sumAllBytes</span>(<span style=color:#a6e22e>r</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Reader</span>) (<span style=color:#66d9ef>uint64</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>buff</span> [<span style=color:#ae81ff>512</span>]<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>sum</span> <span style=color:#66d9ef>uint64</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>n</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>Read</span>(<span style=color:#a6e22e>buff</span>[:])
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#a6e22e>n</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>sum</span> <span style=color:#f92672>+=</span> uint64(<span style=color:#a6e22e>buff</span>[<span style=color:#a6e22e>i</span>])
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Is</span>(<span style=color:#a6e22e>err</span>, <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>EOF</span>) {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sum</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>sum</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>That method can be used to process files, http responses, even memory buffers:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Process a buffer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>buff</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewReader</span>([]<span style=color:#66d9ef>byte</span>{<span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x02</span>, <span style=color:#ae81ff>0x03</span>, <span style=color:#ae81ff>0x04</span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sum</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sumAllBytes</span>(<span style=color:#a6e22e>buff</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Sum from buffer:&#34;</span>, <span style=color:#a6e22e>sum</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Process a http response
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;https://www.google.com&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sum</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>sumAllBytes</span>(<span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Sum from http:&#34;</span>, <span style=color:#a6e22e>sum</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Process a file
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fl</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;/some/file/path&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>fl</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sum</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>sumAllBytes</span>(<span style=color:#a6e22e>fl</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;Sum from file:&#34;</span>, <span style=color:#a6e22e>sum</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=cleaning-up>Cleaning up<a hidden class=anchor aria-hidden=true href=#cleaning-up>#</a></h2><p>In many cases (like the http and file instances above), the reader has to be explicitly closed to avoid resource leaks. For that reason, many resources are using the <a href=https://pkg.go.dev/io#ReadCloser><code>io.ReadCloser</code></a> interface and cleaning up can easily be achieved with a <code>defer rc.Close()</code> statement. But there are some cases where the close method is not called at the same function but somewhere at the caller site. At that construct, the caller is responsible for cleanup:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getDataStream</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadCloser</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>name</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;file&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;/some/file&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;http&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;https://www.google.com/&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#34;buffer&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>NopCloser</span>(
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewReader</span>([]<span style=color:#66d9ef>byte</span>{<span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x02</span>, <span style=color:#ae81ff>0x03</span>, <span style=color:#ae81ff>0x04</span>}),
</span></span><span style=display:flex><span>        ), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;Invalid data stream name&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>printSum</span>(<span style=color:#a6e22e>streamName</span> <span style=color:#66d9ef>string</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>stream</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getDataStream</span>(<span style=color:#a6e22e>streamName</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>defer</span> <span style=color:#a6e22e>stream</span>.<span style=color:#a6e22e>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>sum</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>sumAllBytes</span>(<span style=color:#a6e22e>stream</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Fatal</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>log</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Sum of bytes in stream &#39;%s&#39; is &#39;%d\n&#34;</span>, <span style=color:#a6e22e>streamName</span>, <span style=color:#a6e22e>sum</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>So far so good, nothing to worry about. But let&rsquo;s extend this example with some stream wrapping:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getDataStream</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadCloser</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>name</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>name</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;file&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;/some/file&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>name</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;http&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;https://www.google.com/&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>name</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;buffer&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>NopCloser</span>(
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewReader</span>([]<span style=color:#66d9ef>byte</span>{<span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x02</span>, <span style=color:#ae81ff>0x03</span>, <span style=color:#ae81ff>0x04</span>}),
</span></span><span style=display:flex><span>        ), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// v---  Create a truncated stream by applying limit over the base one ---v
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>HasPrefix</span>(<span style=color:#a6e22e>name</span>, <span style=color:#e6db74>&#34;limit:&#34;</span>):
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getDataStream</span>(<span style=color:#a6e22e>name</span>[<span style=color:#ae81ff>6</span>:])
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>LimitReader</span>(<span style=color:#a6e22e>r</span>, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;Invalid data stream name&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Unfortunately this code does not compile and ends up with this error:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>cannot use io.LimitReader(r, 100) (value of type io.Reader) as type io.ReadCloser in return statement:
</span></span><span style=display:flex><span>    io.Reader does not implement io.ReadCloser (missing Close method)
</span></span></code></pre></div><p>Wrapping the <a href=https://pkg.go.dev/io#ReadCloser><code>io.ReadCloser</code></a> with <a href=https://pkg.go.dev/io#LimitedReader><code>io.LimitedReader</code></a> does hide the <a href=https://pkg.go.dev/io#Closer><code>io.Closer</code></a> functionality of the original instance. And it turns out that there are many places in golang standard lib where such wrapping takes place.</p><h2 id=inline-struct-to-the-rescue>Inline struct to the rescue<a hidden class=anchor aria-hidden=true href=#inline-struct-to-the-rescue>#</a></h2><p>There&rsquo;s an easy trick to bring back the <code>Close</code> method from the original reader back to the wrapped one:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>getDataStream</span>(<span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>) (<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>ReadCloser</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>name</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>name</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;file&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Open</span>(<span style=color:#e6db74>&#34;/some/file&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>name</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;http&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resp</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>Get</span>(<span style=color:#e6db74>&#34;https://www.google.com/&#34;</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>resp</span>.<span style=color:#a6e22e>Body</span>, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>name</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;buffer&#34;</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>NopCloser</span>(
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>bytes</span>.<span style=color:#a6e22e>NewReader</span>([]<span style=color:#66d9ef>byte</span>{<span style=color:#ae81ff>0x01</span>, <span style=color:#ae81ff>0x02</span>, <span style=color:#ae81ff>0x03</span>, <span style=color:#ae81ff>0x04</span>}),
</span></span><span style=display:flex><span>        ), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// v---  Create a truncated stream by applying limit over the base one ---v
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>case</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>HasPrefix</span>(<span style=color:#a6e22e>name</span>, <span style=color:#e6db74>&#34;limit:&#34;</span>):
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>r</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>getDataStream</span>(<span style=color:#a6e22e>name</span>[<span style=color:#ae81ff>6</span>:])
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>limitReader</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>LimitReader</span>(<span style=color:#a6e22e>r</span>, <span style=color:#ae81ff>3</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Reader</span>
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>Closer</span>
</span></span><span style=display:flex><span>        }{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Reader</span>: <span style=color:#a6e22e>limitReader</span>, <span style=color:#75715e>// Read method will come from the wrapped reader
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>Closer</span>: <span style=color:#a6e22e>r</span>,           <span style=color:#75715e>// Close method will come from the original reader
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        }, <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>default</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>New</span>(<span style=color:#e6db74>&#34;Invalid data stream name&#34;</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=how-does-it-work>How does it work?<a hidden class=anchor aria-hidden=true href=#how-does-it-work>#</a></h2><p>The inline <code>struct</code> contains two <a href=https://go.dev/ref/spec#EmbeddedField>embedded fields</a>, one for the reader and the other for the closer.</p><p>Since those fields are anonymous, the struct itself <em>inherits</em> methods from those fields as if those were declared on the struct. By doing so, whenever the compiler tries to cast the struct to some interface, it can <em>promote</em> those methods to fulfil the requirements of the interface.</p><p>In the code above we return an instance of <a href=https://pkg.go.dev/io#ReadCloser><code>io.ReadCloser</code></a> interface that requires both <code>Read</code> and <code>Close</code> methods - and those are <em>borrowed</em> from embedded fields respectively.</p><p>Interestingly, if we would use whole <a href=https://pkg.go.dev/io#ReadCloser><code>io.ReadCloser</code></a> as the second embedded field instead of <a href=https://pkg.go.dev/io#Reader><code>io.Reader</code></a>, the compiler (go 1.19 as of writing) throws an error which is caused by ambiguity between promoted field members (the <code>Read</code> method is not promoted due to ambiguity):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-plain data-lang=plain><span style=display:flex><span>cannot use struct{io.Reader; io.ReadCloser}{…} (value of type struct{io.Reader; io.ReadCloser}) as type io.ReadCloser in return statement:
</span></span><span style=display:flex><span>    struct{io.Reader; io.ReadCloser} does not implement io.ReadCloser (missing Read method)
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.bswiecki.dev/tags/go/>go</a></li><li><a href=https://blog.bswiecki.dev/tags/til/>til</a></li><li><a href=https://blog.bswiecki.dev/tags/code/>code</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://blog.bswiecki.dev/>Just a dev blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><link href=https://blog.bswiecki.dev/css/mermaid.css type=text/css rel=stylesheet><script defer src=https://blog.bswiecki.dev/js/mermaid.js onload=mermaid.initialize({startOnLoad:!0})></script>
<link href=https://blog.bswiecki.dev/css/katex.css type=text/css rel=stylesheet><script defer src=https://blog.bswiecki.dev/js/katex.js></script>
<script defer src=https://blog.bswiecki.dev/js/katex-auto-render.js onload=renderMathInElement(document.body)></script>
<script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>